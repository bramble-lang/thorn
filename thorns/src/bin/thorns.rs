//! Hosts bramblec analysis data and compiler visibility data for use with
//! the Bramble Viewer GUI. This service is started within or is manually pointed
//! to the output (target) directory of the Bramble compiler and serves the
//! visibility data generated by the compiler for use by dev tools.  Critically
//! this service acts to convert and query that data into a form that is
//! useable by dev tools.

use std::path::PathBuf;

use clap::StructOpt;
use rocket::fairing::AdHoc;

use thorns::cors::CORS;
use thorns::sourcemap::SourceMap;
use thorns::trace::Trace;
use thorns::{cli, service::*};

const VIEWER_PATH_ENV: &str = "BRAMBLE_THORNS_VIEWER_PATH";
const DEFAULT_VIEWER_PATH: &str = "/usr/lib/thorns/viewer";

#[macro_use]
extern crate rocket;

#[launch]
fn rocket() -> _ {
    rocket::build()
        .mount("/", routes![get_files, get_file, get_span])
        .attach(stage())
        .attach(CORS)
}

/// Configure the shared state of the trace data and source map
fn stage() -> AdHoc {
    AdHoc::on_ignite("thorns", move |rocket| async {
        // Load configuration from CLI
        let args = cli::Cli::parse();
        let target_dir = args.target().to_path_buf();

        // Load the compiler visibility data
        let trace_path = get_trace_file(target_dir.clone());
        let trace = Trace::load(trace_path).unwrap();

        let sourcemap_path = get_sourcemap_file(target_dir.clone());
        let sourcemap = SourceMap::load(sourcemap_path).unwrap();

        // Check if there is an env override for the location of the Viewer React app
        let viewer_path = std::env::var(VIEWER_PATH_ENV).unwrap_or(DEFAULT_VIEWER_PATH.to_string());

        rocket
            .mount("/", rocket::fs::FileServer::from(&viewer_path))
            .mount("/data", routes![get_data, get_graph])
            .manage(trace)
            .manage(sourcemap)
            .attach(CORS)
    })
}

/// Returns the path to the trace file
fn get_trace_file(dir: PathBuf) -> PathBuf {
    let mut pb = dir.to_path_buf();
    pb.push("trace.json");
    pb
}

/// Returns the path to the source map file
fn get_sourcemap_file(dir: PathBuf) -> PathBuf {
    let mut pb = dir.to_path_buf();
    pb.push("sourcemap.json");
    pb
}
